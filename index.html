<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Expense tracker ¬∑ John + Jane</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: #f4f7fb;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 16px 8px 40px;
        }
        .app {
            max-width: 600px;
            width: 100%;
        }
        .card {
            background: white;
            border-radius: 28px;
            box-shadow: 0 8px 24px rgba(0,10,30,0.08);
            padding: 24px 20px;
            margin-bottom: 20px;
            transition: 0.2s;
            border: 1px solid #f0f2f5;
        }
        h1 {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0b2a3c;
            margin-bottom: 6px;
        }
        .dollar-logo {
            font-size: 2.2rem;
            font-weight: 600;
            color: #1e5b8a;
            background: #e9f0f9;
            width: 52px;
            height: 52px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .page-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
            background: #eaf1f9;
            padding: 6px;
            border-radius: 60px;
        }
        .page-toggle button {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 10px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            color: #2b4d6a;
            cursor: pointer;
            transition: 0.15s;
        }
        .page-toggle button.active {
            background: white;
            box-shadow: 0 4px 10px rgba(0,30,50,0.1);
            color: #104c77;
        }
        .fortnight-badge {
            font-size: 0.9rem;
            background: #d7e7ff;
            color: #035388;
            padding: 8px 14px;
            border-radius: 40px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 8px 0 12px;
        }
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            row-gap: 12px;
            margin-bottom: 16px;
        }
        .budget-header h2 {
            font-size: 1.4rem;
            font-weight: 550;
            color: #16394e;
        }
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-outline {
            background: none;
            border: 1px solid #b7ccdd;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #1d3b50;
            cursor: pointer;
            transition: 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-outline:hover {
            background: #e3edf5;
        }
        .btn-outline.accent {
            background: #1b3d5c;
            border-color: #143649;
            color: white;
        }
        .reset-btn {
            background: none;
            border: 1px solid #cbd5e1;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #2c3e4f;
            cursor: pointer;
        }
        .reset-btn:hover {
            background: #eef2f6;
        }
        .export-import {
            display: flex;
            gap: 10px;
            margin: 12px 0 6px;
            flex-wrap: wrap;
        }
        .export-import button {
            background: #e6effa;
            border: 1px solid #b1cbe2;
            border-radius: 40px;
            padding: 10px 20px;
            font-weight: 500;
            color: #1b4e79;
            cursor: pointer;
            flex: 1;
            font-size: 0.95rem;
        }
        .export-import button:hover {
            background: #d2e2f5;
        }
        .category-grid {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin: 24px 0 16px;
        }
        .category-row {
            background: #f9fcff;
            border-radius: 24px;
            padding: 14px 18px;
            border: 1px solid #dee7ef;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }
        .cat-info {
            flex: 2 1 160px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cat-name-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
        }
        .cat-name {
            font-weight: 600;
            color: #1e3b4f;
            background: transparent;
            border: 1px dashed #9cb8d3;
            border-radius: 30px;
            padding: 5px 12px;
            font-size: 0.95rem;
            width: 110px;
        }
        .cat-name:focus {
            outline: 2px solid #3670a8;
            border-color: #3670a8;
            background: white;
        }
        .delete-cat {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #9fadbc;
            padding: 0 4px;
            border-radius: 30px;
        }
        .delete-cat:hover {
            color: #b12626;
            background: #ffe3e3;
        }
        .cat-budget {
            background: #e3eef9;
            border-radius: 30px;
            padding: 5px 12px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #11517c;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .cat-budget input {
            width: 80px;
            border: none;
            background: transparent;
            font-weight: 600;
            font-size: 0.95rem;
            color: #0a3142;
            padding: 4px 0 4px 6px;
            border-bottom: 1.5px dashed #7fa3c2;
        }
        .cat-budget input:focus {
            outline: none;
            border-bottom-color: #0057a3;
        }
        .progress-section {
            flex: 3 1 200px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        .progress-bar-bg {
            background: #dce5ed;
            height: 10px;
            border-radius: 20px;
            flex: 1 1 120px;
            min-width: 100px;
        }
        .progress-fill {
            height: 10px;
            border-radius: 20px;
            background: #1d7eb5;
            width: 0%;
        }
        .cat-spent {
            font-weight: 550;
            color: #2a4f6e;
            min-width: 70px;
            text-align: right;
            font-size: 0.95rem;
        }
        .cat-left {
            font-weight: 600;
            color: #0b4d3b;
            background: #e0f0e9;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .left-warning {
            color: #a13e3e;
            background: #ffe6e2;
        }
        .add-purchase {
            background: #ffffff;
            border-radius: 30px;
            padding: 20px 16px;
            border: 1px solid #cbddee;
            margin: 26px 0 16px;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 14px;
            align-items: center;
        }
        .form-field {
            flex: 1 1 130px;
            display: flex;
            align-items: center;
            gap: 5px;
            background: #f2f7fd;
            padding: 6px 16px 6px 12px;
            border-radius: 40px;
            border: 1px solid #c1d9ec;
        }
        .form-field span {
            color: #3d637f;
            font-size: 0.95rem;
        }
        .form-field input, .form-field select {
            border: none;
            background: transparent;
            padding: 8px 0;
            font-size: 1rem;
            flex: 1;
            min-width: 100px;
        }
        .form-field input:focus, .form-field select:focus {
            outline: none;
        }
        .form-field select {
            cursor: pointer;
        }
        .who-group {
            display: flex;
            gap: 8px;
            background: #f2f7fd;
            padding: 4px 6px;
            border-radius: 40px;
            border: 1px solid #c1d9ec;
        }
        .who-option {
            padding: 8px 22px;
            border-radius: 34px;
            font-weight: 500;
            background: transparent;
            color: #2b577c;
            cursor: pointer;
            transition: 0.1s;
            border: none;
            font-size: 0.95rem;
        }
        .who-option.active {
            background: #1e4e72;
            color: white;
        }
        .add-btn {
            background: #1b3d5c;
            border: none;
            color: white;
            font-weight: 600;
            padding: 14px 30px;
            border-radius: 40px;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,40,70,0.2);
            transition: 0.15s;
            border: 1px solid #163246;
            flex: 1 0 100%;
        }
        .add-btn:hover {
            background: #0f2c41;
        }
        .history-title {
            display: flex;
            justify-content: space-between;
            margin: 16px 4px 10px;
            font-weight: 600;
            color: #253e52;
        }
        .purchase-list {
            list-style: none;
            background: #f8fafd;
            border-radius: 24px;
            padding: 8px 4px;
            border: 1px solid #e2eaf2;
        }
        .purchase-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid #e6edf5;
            font-size: 0.95rem;
        }
        .purchase-item:last-child {
            border-bottom: none;
        }
        .purchase-left {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }
        .purchase-cat {
            background: #daeaf5;
            padding: 4px 12px;
            border-radius: 40px;
            font-weight: 500;
            color: #175277;
        }
        .purchase-who {
            background: #e1d7fc;
            padding: 4px 12px;
            border-radius: 40px;
            font-weight: 500;
            color: #3c346b;
        }
        .purchase-name {
            font-weight: 500;
            color: #1e3347;
        }
        .purchase-amount {
            font-weight: 650;
            color: #1d3a53;
            padding-left: 12px;
        }
        .delete-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: #9fadbc;
            padding: 0 6px;
        }
        .delete-btn:hover {
            color: #c03b3b;
        }
        .footer-note {
            color: #7d93aa;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 24px;
        }
        input[type="number"]::-webkit-inner-spin-button {
            opacity: 0.5;
        }
        .new-cat-row {
            margin-top: 20px;
            display: flex;
            gap: 8px;
            align-items: center;
            background: #f2f8fe;
            padding: 12px 20px;
            border-radius: 50px;
        }
        .new-cat-row input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 6px;
            font-size: 1rem;
            border-bottom: 1.5px dashed #7a9ebe;
        }
        .new-cat-row input:focus {
            outline: none;
            border-bottom-color: #175277;
        }
        .new-cat-row button {
            background: #1d5179;
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 22px;
            border-radius: 40px;
            cursor: pointer;
            white-space: nowrap;
        }
        .new-cat-row button:hover {
            background: #0f3a57;
        }
        .summary-card {
            background: linear-gradient(145deg, #e7f0fa, #ffffff);
            border-radius: 28px;
            padding: 24px;
            margin-bottom: 22px;
            border: 1px solid #c9ddec;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: 600;
            color: #19415b;
            padding: 8px 0;
        }
        .summary-row.remaining {
            border-top: 2px dashed #aac3db;
            margin-top: 10px;
            padding-top: 16px;
            font-size: 1.5rem;
            color: #1a4d3e;
        }
        .income-list, .bills-list {
            margin-bottom: 28px;
        }
        .income-item, .bill-item {
            background: #f1f8ff;
            border-radius: 40px;
            padding: 14px 20px;
            margin-bottom: 8px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #d3e2f2;
        }
        .bill-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            align-items: center;
        }
        .bill-frequency {
            background: #d9e4f0;
            border-radius: 40px;
            padding: 4px 14px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #1d4c73;
        }
        .bill-next {
            background: #fdefd4;
            border-radius: 40px;
            padding: 4px 14px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #9a6100;
        }
        .income-amount, .bill-amount {
            font-weight: 700;
            color: #1a3f5c;
        }
        .add-bill-form {
            background: #f3f9ff;
            border-radius: 30px;
            padding: 22px 16px;
            margin: 20px 0 10px;
        }
        .inline-delete {
            background: none;
            border: none;
            font-size: 1.3rem;
            color: #9fadbc;
            cursor: pointer;
            padding: 0 6px;
        }
        .inline-delete:hover { color: #b12626; }
        .file-input {
            display: none;
        }
    </style>
</head>
<body>
<div class="app" id="app">
    <div class="card" style="padding-bottom: 10px;">
        <h1>
            <span class="dollar-logo">$</span>
            Expense tracker
        </h1>
        <!-- page toggle: expenses / income+bills -->
        <div class="page-toggle">
            <button :class="{ active: currentPage === 'expenses' }" @click="currentPage = 'expenses'">üìä Expenses</button>
            <button :class="{ active: currentPage === 'income' }" @click="currentPage = 'income'">üí∞ Income & Bills</button>
        </div>
        
        <!-- EXPORT/IMPORT BUTTONS - always visible -->
        <div class="export-import">
            <button @click="exportData">üì§ Export Data</button>
            <button @click="triggerImport">üì• Import Data</button>
            <input type="file" ref="fileInput" class="file-input" accept=".json" @change="importData">
        </div>
        
        <div class="fortnight-badge" v-if="currentPage === 'expenses'">
            <span>‚è≥ fortnight</span> <strong>Feb 24</strong> ¬∑ <span>to</span> <strong>Mar 10</strong>
        </div>
        <div class="fortnight-badge" v-else>
            <span>üìÖ upcoming bills</span> <strong>{{ nextBillReminder }}</strong>
        </div>
    </div>

    <!-- EXPENSES PAGE -->
    <div v-if="currentPage === 'expenses'">
        <div class="card">
            <div class="budget-header">
                <h2>üìÅ categories</h2>
                <div class="header-actions">
                    <button class="btn-outline" @click="addNewCategoryPrompt">‚ûï add category</button>
                    <button class="reset-btn" @click="resetFortnight">‚Üª reset fortnight</button>
                </div>
            </div>
            <div class="category-grid">
                <div v-for="(cat, idx) in categories" :key="cat.id" class="category-row">
                    <div class="cat-info">
                        <div class="cat-name-wrapper">
                            <input type="text" class="cat-name" v-model="cat.name" @input="updateStorage" placeholder="name">
                            <button class="delete-cat" @click="removeCategory(cat.id, idx)" title="delete category">‚úï</button>
                        </div>
                        <div class="cat-budget"><span>$</span><input type="number" min="0" step="1" v-model.number="cat.budget" @input="updateStorage" placeholder="budget"></div>
                    </div>
                    <div class="progress-section">
                        <div class="progress-bar-bg"><div class="progress-fill" :style="{ width: progressPercent(cat) }"></div></div>
                        <span class="cat-spent">${{ cat.spent }}</span>
                        <span class="cat-left" :class="{ 'left-warning': cat.budget - cat.spent < 0 }">${{ cat.budget - cat.spent }}</span>
                    </div>
                </div>
            </div>
            <div class="new-cat-row">
                <input type="text" v-model="newCategoryName" placeholder="new category name" @keyup.enter="commitNewCategory">
                <button @click="commitNewCategory">‚ûï add</button>
            </div>

            <div class="add-purchase">
                <div class="form-row">
                    <div class="form-field"><span>üì¶</span><input type="text" v-model="newPurchase.description" placeholder="item name" @keyup.enter="addPurchase"></div>
                    <div class="form-field"><span>$</span><input type="number" min="0" step="0.01" v-model.number="newPurchase.amount" placeholder="0" @keyup.enter="addPurchase"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><span>üìÇ</span>
                        <select v-model="newPurchase.categoryId">
                            <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                        </select>
                    </div>
                    <div class="who-group">
                        <button type="button" class="who-option" :class="{ active: newPurchase.who === 'John' }" @click="newPurchase.who = 'John'">üë® John</button>
                        <button type="button" class="who-option" :class="{ active: newPurchase.who === 'Jane' }" @click="newPurchase.who = 'Jane'">üë© Jane</button>
                    </div>
                </div>
                <button class="add-btn" @click="addPurchase">+ add purchase</button>
            </div>
        </div>

        <div class="card">
            <div class="history-title"><span>üìã purchases this fortnight</span><span>{{ purchases.length }} items</span></div>
            <ul class="purchase-list" v-if="purchases.length">
                <li v-for="(p, index) in sortedPurchases" :key="p.id" class="purchase-item">
                    <div class="purchase-left">
                        <span class="purchase-cat">{{ categoryName(p.categoryId) }}</span>
                        <span class="purchase-who">{{ p.who === 'John' ? 'üë® John' : 'üë© Jane' }}</span>
                        <span class="purchase-name">{{ p.description }}</span>
                    </div>
                    <div><span class="purchase-amount">${{ p.amount.toFixed(2) }}</span><button class="delete-btn" @click="deletePurchase(index, p.id)">‚úï</button></div>
                </li>
            </ul>
            <div v-else style="text-align: center; padding: 32px; color: #8fa3b7;">‚ú® purchases show up here</div>
        </div>
    </div>

    <!-- INCOME & BILLS PAGE -->
    <div v-else>
        <div class="card">
            <div class="summary-card">
                <div class="summary-row"><span>üí∞ Fortnightly income:</span> <span>${{ totalIncome }}</span></div>
                <div class="summary-row"><span>üìÖ Fortnightly bills:</span> <span>${{ totalBillsFortnight.toFixed(2) }}</span></div>
                <div class="summary-row remaining"><span>‚úÖ Left over:</span> <span>${{ (totalIncome - totalBillsFortnight).toFixed(2) }}</span></div>
            </div>

            <h2 style="margin-bottom: 12px;">‚ûï Income sources</h2>
            <div class="income-list">
                <div v-for="(inc, idx) in incomeSources" :key="inc.id" class="income-item">
                    <span><strong>{{ inc.name }}</strong> (every fortnight)</span>
                    <div><span class="income-amount">${{ inc.amount }}</span><button class="inline-delete" @click="deleteIncome(idx)">‚úï</button></div>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 8px;">
                    <input type="text" v-model="newIncome.name" placeholder="name (e.g. salary)" style="flex:2; padding: 12px; border-radius: 40px; border:1px solid #cbddee;">
                    <input type="number" v-model="newIncome.amount" placeholder="amount" style="flex:1; padding: 12px; border-radius: 40px; border:1px solid #cbddee;">
                    <button class="btn-outline" @click="addIncome" style="white-space: nowrap;">add</button>
                </div>
            </div>

            <h2 style="margin: 24px 0 12px;">üìã Bills</h2>
            <div class="bills-list">
                <div v-for="(bill, idx) in bills" :key="bill.id" class="bill-item">
                    <div class="bill-details">
                        <strong>{{ bill.name }}</strong>
                        <span class="bill-frequency">{{ bill.frequency }}</span>
                        <span class="bill-next">next: {{ bill.nextDate }}</span>
                    </div>
                    <div><span class="bill-amount">${{ bill.amount }}</span><button class="inline-delete" @click="deleteBill(idx)">‚úï</button></div>
                </div>
            </div>

            <div class="add-bill-form">
                <h3 style="margin-bottom: 18px;">‚ûï Add new bill</h3>
                <div style="display: flex; flex-direction: column; gap: 14px;">
                    <input type="text" v-model="newBill.name" placeholder="Bill name (e.g. rent, internet)" style="padding: 12px; border-radius: 40px; border:1px solid #b7ccdd;">
                    <input type="number" v-model="newBill.amount" placeholder="Amount $" style="padding: 12px; border-radius: 40px; border:1px solid #b7ccdd;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select v-model="newBill.frequency" style="flex:1; padding: 12px; border-radius: 40px; border:1px solid #b7ccdd;">
                            <option value="fortnightly">Fortnightly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                        <input type="date" v-model="newBill.nextDate" style="flex:1; padding: 12px; border-radius: 40px; border:1px solid #b7ccdd;">
                    </div>
                    <button class="add-btn" @click="addBill" style="margin-top: 8px;">+ add bill</button>
                </div>
            </div>
            <p style="color: #7f99b3; font-size:0.9rem; margin-top:12px;">Monthly bills are converted to fortnightly for the leftover calculation.</p>
        </div>
    </div>

    <div class="footer-note">John & Jane ¬∑ Export/import to share data</div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    const defaultCategories = [
        { id: 'c1', name: 'groceries', budget: 200, spent: 0 },
        { id: 'c2', name: 'dining out', budget: 100, spent: 0 },
        { id: 'c3', name: 'transport', budget: 80, spent: 0 },
        { id: 'c4', name: 'entertainment', budget: 60, spent: 0 },
        { id: 'c5', name: 'household', budget: 70, spent: 0 }
    ];

    const app = createApp({
        setup() {
            const currentPage = ref('expenses');
            const categories = ref([]);
            const purchases = ref([]);
            const newPurchase = reactive({ description: '', amount: null, categoryId: '', who: 'John' });
            const newCategoryName = ref('');

            const incomeSources = ref([]);
            const bills = ref([]);
            const newIncome = reactive({ name: '', amount: null });
            const newBill = reactive({ name: '', amount: null, frequency: 'monthly', nextDate: '' });

            // file import ref
            const fileInput = ref(null);

            // static fortnight display
            const fortnightStart = 'Feb 24';
            const fortnightEnd = 'Mar 10';

            // ---- helpers ----
            function saveToLocal() {
                localStorage.setItem('expense_categories', JSON.stringify(categories.value));
                localStorage.setItem('expense_purchases', JSON.stringify(purchases.value));
                localStorage.setItem('income_sources', JSON.stringify(incomeSources.value));
                localStorage.setItem('bills_list', JSON.stringify(bills.value));
            }

            function loadFromLocal() {
                categories.value = JSON.parse(localStorage.getItem('expense_categories')) || defaultCategories.map(c => ({...c}));
                purchases.value = JSON.parse(localStorage.getItem('expense_purchases')) || [];
                incomeSources.value = JSON.parse(localStorage.getItem('income_sources')) || [];
                bills.value = JSON.parse(localStorage.getItem('bills_list')) || [];

                categories.value.forEach(c => { if (c.spent === undefined) c.spent = 0; });
                if (categories.value.length && !newPurchase.categoryId) newPurchase.categoryId = categories.value[0].id;
            }

            function recalcSpent() {
                categories.value.forEach(c => c.spent = 0);
                purchases.value.forEach(p => {
                    const cat = categories.value.find(c => c.id === p.categoryId);
                    if (cat) cat.spent += p.amount;
                });
                saveToLocal();
            }

            // expenses functions
            function addPurchase() {
                if (!newPurchase.description.trim() || !newPurchase.amount || newPurchase.amount <= 0) return alert('Valid description and amount');
                purchases.value.push({
                    id: Date.now()+'-'+Math.random().toString(36).substring(2,8),
                    description: newPurchase.description.trim(),
                    amount: Number(newPurchase.amount),
                    categoryId: newPurchase.categoryId,
                    who: newPurchase.who,
                    timestamp: Date.now()
                });
                newPurchase.description = ''; newPurchase.amount = null;
                recalcSpent();
            }
            function deletePurchase(index) { purchases.value.splice(index, 1); recalcSpent(); }
            function resetFortnight() { if (confirm('Clear purchases?')) { purchases.value = []; recalcSpent(); } }
            function addNewCategoryPrompt() { let n = prompt('Category name:'); if (n && n.trim()) addCategory(n.trim()); }
            function addCategory(name) {
                categories.value.push({ id: 'cat_'+Date.now()+'_'+Math.random().toString(36).substring(2,6), name, budget: 50, spent: 0 });
                if (categories.value.length===1) newPurchase.categoryId = categories.value[0].id;
                saveToLocal();
            }
            function commitNewCategory() { if (newCategoryName.value.trim()) { addCategory(newCategoryName.value.trim()); newCategoryName.value = ''; } }
            function removeCategory(catId, idx) {
                if (categories.value.length <= 1) return alert('Keep at least one');
                if (purchases.value.some(p => p.categoryId === catId) && !confirm('Category has purchases. Delete?')) return;
                purchases.value = purchases.value.filter(p => p.categoryId !== catId);
                categories.value.splice(idx, 1);
                if (!categories.value.find(c => c.id === newPurchase.categoryId)) newPurchase.categoryId = categories.value[0]?.id || '';
                recalcSpent();
            }
            function updateStorage() { saveToLocal(); }
            function progressPercent(cat) { return cat.budget<=0 ? '0%' : Math.min((cat.spent/cat.budget)*100,100)+'%'; }
            function categoryName(catId) { return categories.value.find(c=>c.id===catId)?.name || '?'; }
            const sortedPurchases = computed(() => [...purchases.value].sort((a,b)=>b.timestamp - a.timestamp));

            // income functions
            function addIncome() {
                if (!newIncome.name.trim() || !newIncome.amount || newIncome.amount <=0) return alert('Valid name and amount');
                incomeSources.value.push({ id: Date.now()+'-'+Math.random().toString(36).substring(2,6), name: newIncome.name.trim(), amount: Number(newIncome.amount) });
                newIncome.name = ''; newIncome.amount = null;
                saveToLocal();
            }
            function deleteIncome(idx) { incomeSources.value.splice(idx,1); saveToLocal(); }
            const totalIncome = computed(() => incomeSources.value.reduce((sum,i)=> sum + i.amount, 0));

            // bills functions
            function addBill() {
                if (!newBill.name.trim() || !newBill.amount || newBill.amount <=0 || !newBill.nextDate) return alert('Complete all fields');
                bills.value.push({
                    id: Date.now()+'-'+Math.random().toString(36).substring(2,6),
                    name: newBill.name.trim(),
                    amount: Number(newBill.amount),
                    frequency: newBill.frequency,
                    nextDate: newBill.nextDate
                });
                newBill.name = ''; newBill.amount = null; newBill.frequency = 'monthly'; newBill.nextDate = '';
                saveToLocal();
            }
            function deleteBill(idx) { bills.value.splice(idx,1); saveToLocal(); }

            const totalBillsFortnight = computed(() => {
                return bills.value.reduce((sum, b) => {
                    if (b.frequency === 'fortnightly') return sum + b.amount;
                    else return sum + (b.amount * 12 / 26);
                }, 0);
            });

            const nextBillReminder = computed(() => {
                if (!bills.value.length) return 'no bills';
                const today = new Date();
                let nearest = null;
                bills.value.forEach(b => {
                    const d = new Date(b.nextDate);
                    if (!isNaN(d) && (!nearest || d < nearest)) nearest = d;
                });
                return nearest ? nearest.toLocaleDateString('en-US',{month:'short', day:'numeric'}) : 'add dates';
            });

            // ----- EXPORT / IMPORT -----
            function exportData() {
                const data = {
                    categories: categories.value,
                    purchases: purchases.value,
                    incomeSources: incomeSources.value,
                    bills: bills.value,
                    exportDate: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `expense-tracker-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function triggerImport() {
                fileInput.value.click();
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // validate basic structure
                        if (data.categories && Array.isArray(data.categories)) {
                            categories.value = data.categories.map(c => ({ ...c, spent: c.spent || 0 }));
                        }
                        if (data.purchases && Array.isArray(data.purchases)) {
                            purchases.value = data.purchases;
                        }
                        if (data.incomeSources && Array.isArray(data.incomeSources)) {
                            incomeSources.value = data.incomeSources;
                        }
                        if (data.bills && Array.isArray(data.bills)) {
                            bills.value = data.bills;
                        }
                        
                        // ensure category selection
                        if (categories.value.length && !newPurchase.categoryId) {
                            newPurchase.categoryId = categories.value[0].id;
                        }
                        
                        recalcSpent();
                        alert('Data imported successfully!');
                    } catch (err) {
                        alert('Invalid file format. Please select a valid backup file.');
                        console.error(err);
                    }
                    // reset file input so same file can be chosen again
                    event.target.value = '';
                };
                reader.readAsText(file);
            }

            onMounted(() => { loadFromLocal(); recalcSpent(); });
            watch([categories, purchases, incomeSources, bills], saveToLocal, { deep: true });

            return {
                currentPage, categories, purchases, newPurchase, newCategoryName,
                incomeSources, bills, newIncome, newBill,
                fortnightStart, fortnightEnd,
                addPurchase, deletePurchase, resetFortnight, addNewCategoryPrompt,
                commitNewCategory, removeCategory, updateStorage, progressPercent,
                categoryName, sortedPurchases, addIncome, deleteIncome, totalIncome,
                addBill, deleteBill, totalBillsFortnight, nextBillReminder,
                exportData, triggerImport, importData, fileInput
            };
        }
    });
    app.mount('#app');
</script>
</body>
</html>
