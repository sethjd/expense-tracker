<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Expense tracker ¬∑ John + Jane</title>
    <style>
        /* Dark mode variables - light theme default */
        :root {
            --bg-primary: #f4f7fb;
            --bg-card: white;
            --text-primary: #0b2a3c;
            --text-secondary: #16394e;
            --badge-bg: #d7e7ff;
            --badge-text: #035388;
            --border-light: #f0f2f5;
            --category-bg: #f9fcff;
            --category-border: #dee7ef;
            --input-bg: #f2f7fd;
            --input-border: #c1d9ec;
            --progress-bg: #dce5ed;
            --progress-fill: #1d7eb5;
            --btn-outline: #b7ccdd;
            --btn-outline-text: #1d3b50;
            --who-bg: #f2f7fd;
            --who-border: #c1d9ec;
            --who-active: #1e4e72;
            --who-active-text: white;
            --purchase-bg: #f8fafd;
            --purchase-border: #e2eaf2;
            --purchase-cat: #daeaf5;
            --purchase-who: #e1d7fc;
            --delete-btn: #9fadbc;
            --footer-text: #7d93aa;
            --summary-bg: linear-gradient(145deg, #e7f0fa, #ffffff);
            --summary-border: #c9ddec;
            --bill-bg: #f1f8ff;
            --bill-border: #d3e2f2;
            --bill-frequency: #d9e4f0;
            --bill-next: #fdefd4;
            --calendar-overlay: rgba(0,20,40,0.5);
            --calendar-panel: white;
            --calendar-item: #f1f8ff;
            --calendar-border: #c5d9ef;
        }

        /* Dark theme overrides */
        body.dark-mode {
            --bg-primary: #1a2634;
            --bg-card: #2a3747;
            --text-primary: #e6edf5;
            --text-secondary: #c9ddec;
            --badge-bg: #2d4b6e;
            --badge-text: #c9e2ff;
            --border-light: #3a4a5e;
            --category-bg: #2f4053;
            --category-border: #4a5e74;
            --input-bg: #33465b;
            --input-border: #5a6f88;
            --progress-bg: #3f556b;
            --progress-fill: #4a9fd8;
            --btn-outline: #5a6f88;
            --btn-outline-text: #d9e6f2;
            --who-bg: #33465b;
            --who-border: #5a6f88;
            --who-active: #3a6e9f;
            --who-active-text: white;
            --purchase-bg: #2f4053;
            --purchase-border: #4a5e74;
            --purchase-cat: #3d5a7a;
            --purchase-who: #5d4f7a;
            --delete-btn: #8a9bb0;
            --footer-text: #9aafc9;
            --summary-bg: linear-gradient(145deg, #2d4055, #2a3747);
            --summary-border: #4a5e74;
            --bill-bg: #2f4053;
            --bill-border: #4a5e74;
            --bill-frequency: #3d5a7a;
            --bill-next: #7d6a45;
            --calendar-overlay: rgba(0,0,0,0.7);
            --calendar-panel: #2a3747;
            --calendar-item: #2f4053;
            --calendar-border: #4a5e74;
        }

        body {
            background: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 16px 8px 40px;
            transition: background-color 0.3s, color 0.2s;
            margin: 0;
        }
        .app {
            max-width: 600px;
            width: 100%;
        }
        .card {
            background: var(--bg-card);
            border-radius: 28px;
            box-shadow: 0 8px 24px rgba(0,10,30,0.08);
            padding: 24px 20px;
            margin-bottom: 20px;
            transition: 0.2s;
            border: 1px solid var(--border-light);
            color: var(--text-primary);
        }
        h1 {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        .dollar-logo {
            font-size: 2.2rem;
            font-weight: 600;
            color: #1e5b8a;
            background: #e9f0f9;
            width: 52px;
            height: 52px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .dark-mode .dollar-logo {
            background: #3a5a7a;
            color: #c9e2ff;
        }
        .page-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 18px;
            background: var(--input-bg);
            padding: 6px;
            border-radius: 60px;
        }
        .page-toggle button {
            flex: 1;
            border: none;
            background: transparent;
            padding: 12px 10px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: 0.15s;
        }
        .page-toggle button.active {
            background: var(--bg-card);
            box-shadow: 0 4px 10px rgba(0,30,50,0.1);
            color: var(--text-primary);
        }
        .fortnight-badge {
            font-size: 0.9rem;
            background: var(--badge-bg);
            color: var(--badge-text);
            padding: 8px 14px;
            border-radius: 40px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 8px 0 12px;
            cursor: pointer;
            transition: 0.2s;
        }
        .fortnight-badge:hover {
            filter: brightness(0.95);
            transform: scale(1.02);
        }
        /* calendar popup */
        .calendar-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--calendar-overlay);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(3px);
        }
        .calendar-panel {
            background: var(--calendar-panel);
            border-radius: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 28px 22px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
            color: var(--text-primary);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--delete-btn);
            padding: 0 12px;
        }
        .calendar-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .calendar-item {
            background: var(--calendar-item);
            border-radius: 60px;
            padding: 16px 22px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--calendar-border);
        }
        .cal-bill-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .cal-bill-name {
            font-weight: 700;
            color: var(--text-primary);
        }
        .cal-bill-meta {
            font-size: 0.8rem;
            color: var(--footer-text);
            display: flex;
            gap: 10px;
        }
        .cal-bill-amount {
            font-weight: 700;
            color: var(--text-primary);
            background: var(--badge-bg);
            padding: 6px 16px;
            border-radius: 40px;
        }
        .future-tag {
            background: #5f7a4c;
            color: #e2f0c0;
            padding: 2px 12px;
            border-radius: 30px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .no-bills-cal {
            padding: 40px;
            text-align: center;
            color: var(--footer-text);
        }
        .budget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            row-gap: 12px;
            margin-bottom: 16px;
        }
        .budget-header h2 {
            font-size: 1.4rem;
            font-weight: 550;
            color: var(--text-secondary);
        }
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-outline {
            background: none;
            border: 1px solid var(--btn-outline);
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--btn-outline-text);
            cursor: pointer;
            transition: 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-outline:hover {
            background: var(--input-bg);
        }
        .btn-outline.accent {
            background: #1b3d5c;
            border-color: #143649;
            color: white;
        }
        .dark-mode .btn-outline.accent {
            background: #2d557a;
        }
        .reset-btn {
            background: none;
            border: 1px solid var(--btn-outline);
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--btn-outline-text);
            cursor: pointer;
        }
        .reset-btn:hover {
            background: var(--input-bg);
        }
        .export-import {
            display: flex;
            gap: 10px;
            margin: 12px 0 6px;
            flex-wrap: wrap;
        }
        .export-import button {
            background: var(--input-bg);
            border: 1px solid var(--btn-outline);
            border-radius: 40px;
            padding: 10px 20px;
            font-weight: 500;
            color: var(--btn-outline-text);
            cursor: pointer;
            flex: 1;
            font-size: 0.95rem;
        }
        .export-import button:hover {
            background: var(--category-bg);
        }
        .category-grid {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin: 24px 0 16px;
        }
        .category-row {
            background: var(--category-bg);
            border-radius: 24px;
            padding: 14px 18px;
            border: 1px solid var(--category-border);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }
        .cat-info {
            flex: 2 1 160px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .cat-name-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
        }
        .cat-name {
            font-weight: 600;
            color: var(--text-primary);
            background: transparent;
            border: 1px dashed var(--btn-outline);
            border-radius: 30px;
            padding: 5px 12px;
            font-size: 0.95rem;
            width: 110px;
        }
        .cat-name:focus {
            outline: 2px solid #3670a8;
            border-color: #3670a8;
            background: var(--input-bg);
        }
        .delete-cat {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--delete-btn);
            padding: 0 4px;
            border-radius: 30px;
        }
        .delete-cat:hover {
            color: #b12626;
            background: #ffe3e3;
        }
        .cat-budget {
            background: var(--badge-bg);
            border-radius: 30px;
            padding: 5px 12px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--badge-text);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .cat-budget input {
            width: 80px;
            border: none;
            background: transparent;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            padding: 4px 0 4px 6px;
            border-bottom: 1.5px dashed var(--btn-outline);
        }
        .cat-budget input:focus {
            outline: none;
            border-bottom-color: #0057a3;
        }
        .progress-section {
            flex: 3 1 200px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        .progress-bar-bg {
            background: var(--progress-bg);
            height: 10px;
            border-radius: 20px;
            flex: 1 1 120px;
            min-width: 100px;
        }
        .progress-fill {
            height: 10px;
            border-radius: 20px;
            background: var(--progress-fill);
            width: 0%;
        }
        .cat-spent {
            font-weight: 550;
            color: var(--text-secondary);
            min-width: 70px;
            text-align: right;
            font-size: 0.95rem;
        }
        .cat-left {
            font-weight: 600;
            color: #0b4d3b;
            background: #e0f0e9;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .dark-mode .cat-left {
            background: #1d4a3a;
            color: #b0f0d0;
        }
        .left-warning {
            color: #a13e3e;
            background: #ffe6e2;
        }
        .dark-mode .left-warning {
            background: #632e2e;
            color: #ffb0b0;
        }
        .add-purchase {
            background: var(--bg-card);
            border-radius: 30px;
            padding: 20px 16px;
            border: 1px solid var(--input-border);
            margin: 26px 0 16px;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 14px;
            align-items: center;
        }
        .form-field {
            flex: 1 1 130px;
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--input-bg);
            padding: 6px 16px 6px 12px;
            border-radius: 40px;
            border: 1px solid var(--input-border);
        }
        .form-field span {
            color: var(--footer-text);
            font-size: 0.95rem;
        }
        .form-field input, .form-field select {
            border: none;
            background: transparent;
            padding: 8px 0;
            font-size: 1rem;
            flex: 1;
            min-width: 100px;
            color: var(--text-primary);
        }
        .form-field select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .form-field input:focus, .form-field select:focus {
            outline: none;
        }
        .form-field select {
            cursor: pointer;
        }
        .who-group {
            display: flex;
            gap: 8px;
            background: var(--input-bg);
            padding: 4px 6px;
            border-radius: 40px;
            border: 1px solid var(--input-border);
        }
        .who-option {
            padding: 8px 22px;
            border-radius: 34px;
            font-weight: 500;
            background: transparent;
            color: var(--btn-outline-text);
            cursor: pointer;
            transition: 0.1s;
            border: none;
            font-size: 0.95rem;
        }
        .who-option.active {
            background: var(--who-active);
            color: var(--who-active-text);
        }
        .add-btn {
            background: #1b3d5c;
            border: none;
            color: white;
            font-weight: 600;
            padding: 14px 30px;
            border-radius: 40px;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,40,70,0.2);
            transition: 0.15s;
            border: 1px solid #163246;
            flex: 1 0 100%;
        }
        .add-btn:hover {
            background: #0f2c41;
        }
        .dark-mode .add-btn {
            background: #2d557a;
            border-color: #1f3f5a;
        }
        .history-title {
            display: flex;
            justify-content: space-between;
            margin: 16px 4px 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .purchase-list {
            list-style: none;
            background: var(--purchase-bg);
            border-radius: 24px;
            padding: 8px 4px;
            border: 1px solid var(--purchase-border);
        }
        .purchase-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 18px;
            border-bottom: 1px solid var(--purchase-border);
            font-size: 0.95rem;
        }
        .purchase-item:last-child {
            border-bottom: none;
        }
        .purchase-left {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }
        .purchase-cat {
            background: var(--purchase-cat);
            padding: 4px 12px;
            border-radius: 40px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .purchase-who {
            background: var(--purchase-who);
            padding: 4px 12px;
            border-radius: 40px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .purchase-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        .purchase-amount {
            font-weight: 650;
            color: var(--text-primary);
            padding-left: 12px;
        }
        .delete-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--delete-btn);
            padding: 0 6px;
        }
        .delete-btn:hover {
            color: #c03b3b;
        }
        .footer-note {
            color: var(--footer-text);
            font-size: 0.85rem;
            text-align: center;
            margin-top: 24px;
        }
        input[type="number"]::-webkit-inner-spin-button {
            opacity: 0.5;
        }
        .new-cat-row {
            margin-top: 20px;
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--input-bg);
            padding: 12px 20px;
            border-radius: 50px;
        }
        .new-cat-row input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 6px;
            font-size: 1rem;
            border-bottom: 1.5px dashed var(--btn-outline);
            color: var(--text-primary);
        }
        .new-cat-row input:focus {
            outline: none;
            border-bottom-color: #175277;
        }
        .new-cat-row button {
            background: #1d5179;
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 22px;
            border-radius: 40px;
            cursor: pointer;
            white-space: nowrap;
        }
        .new-cat-row button:hover {
            background: #0f3a57;
        }
        .dark-mode .new-cat-row button {
            background: #2d5f8a;
        }
        .summary-card {
            background: var(--summary-bg);
            border-radius: 28px;
            padding: 24px;
            margin-bottom: 22px;
            border: 1px solid var(--summary-border);
            color: var(--text-primary);
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 0;
        }
        .summary-row.remaining {
            border-top: 2px dashed var(--summary-border);
            margin-top: 10px;
            padding-top: 16px;
            font-size: 1.5rem;
            color: #1a4d3e;
        }
        .dark-mode .summary-row.remaining {
            color: #8fe0c0;
        }
        .income-list, .bills-list {
            margin-bottom: 28px;
        }
        .income-item, .bill-item {
            background: var(--bill-bg);
            border-radius: 40px;
            padding: 14px 20px;
            margin-bottom: 8px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--bill-border);
            color: var(--text-primary);
        }
        .bill-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            align-items: center;
        }
        .bill-frequency {
            background: var(--bill-frequency);
            border-radius: 40px;
            padding: 4px 14px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .bill-next {
            background: var(--bill-next);
            border-radius: 40px;
            padding: 4px 14px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .income-amount, .bill-amount {
            font-weight: 700;
            color: var(--text-primary);
        }
        .add-bill-form {
            background: var(--input-bg);
            border-radius: 30px;
            padding: 22px 16px;
            margin: 20px 0 10px;
            border: 1px solid var(--input-border);
        }
        .inline-delete {
            background: none;
            border: none;
            font-size: 1.3rem;
            color: var(--delete-btn);
            cursor: pointer;
            padding: 0 6px;
        }
        .inline-delete:hover { color: #b12626; }
        .file-input {
            display: none;
        }
        .date-optional-hint {
            font-size: 0.8rem;
            color: var(--footer-text);
            margin-left: 12px;
        }
        /* dark mode toggle button */
        .theme-toggle {
            background: var(--input-bg);
            border: 1px solid var(--btn-outline);
            border-radius: 40px;
            padding: 8px 16px;
            font-size: 1rem;
            cursor: pointer;
            color: var(--btn-outline-text);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }
        .theme-toggle:hover {
            background: var(--category-bg);
        }
        .header-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body :class="{ 'dark-mode': isDarkMode }">
<div class="app" id="app">
    <div class="card" style="padding-bottom: 10px;">
        <div class="header-row">
            <h1>
                <span class="dollar-logo">$</span>
                Expense tracker
            </h1>
            <button class="theme-toggle" @click="toggleDarkMode">
                <span>{{ isDarkMode ? '‚òÄÔ∏è' : 'üåô' }}</span>
                {{ isDarkMode ? 'Light' : 'Dark' }}
            </button>
        </div>
        <div class="page-toggle">
            <button :class="{ active: currentPage === 'expenses' }" @click="currentPage = 'expenses'">üìä Expenses</button>
            <button :class="{ active: currentPage === 'income' }" @click="currentPage = 'income'">üí∞ Income & Bills</button>
        </div>
        
        <div class="export-import">
            <button @click="exportData">üì§ Export Data</button>
            <button @click="triggerImport">üì• Import Data</button>
            <input type="file" ref="fileInput" class="file-input" accept=".json" @change="importData">
        </div>
        
        <div class="fortnight-badge" v-if="currentPage === 'expenses'" @click="showCalendar = true">
            <span>‚è≥ fortnight</span> <strong>Feb 24</strong> ¬∑ <span>to</span> <strong>Mar 10</strong>
        </div>
        <div class="fortnight-badge" v-else @click="showCalendar = true">
            <span>üìÖ next bill</span> <strong>{{ nextBillReminder }}</strong> <span style="font-size:0.8rem;">‚Üó calendar</span>
        </div>
    </div>

    <!-- CALENDAR POPUP -->
    <div v-if="showCalendar" class="calendar-overlay" @click.self="showCalendar = false">
        <div class="calendar-panel">
            <div class="calendar-header">
                <span>üìÖ Upcoming bills</span>
                <button class="close-btn" @click="showCalendar = false">‚úï</button>
            </div>
            <div class="calendar-list" v-if="calendarEvents.length">
                <div v-for="ev in calendarEvents" :key="ev.id" class="calendar-item">
                    <div class="cal-bill-info">
                        <span class="cal-bill-name">{{ ev.name }}</span>
                        <span class="cal-bill-meta">
                            <span>{{ ev.frequency }}</span>
                            <span>next: {{ formatDate(ev.date) }}</span>
                            <span v-if="ev.isFuture" class="future-tag">future</span>
                        </span>
                    </div>
                    <span class="cal-bill-amount">${{ ev.amount }}</span>
                </div>
            </div>
            <div v-else class="no-bills-cal">‚ú® No bills with dates yet. Add a date to a bill.</div>
        </div>
    </div>

    <!-- EXPENSES PAGE -->
    <div v-if="currentPage === 'expenses'">
        <div class="card">
            <div class="budget-header">
                <h2>üìÅ categories</h2>
                <div class="header-actions">
                    <button class="btn-outline" @click="addNewCategoryPrompt">‚ûï add category</button>
                    <button class="reset-btn" @click="resetFortnight">‚Üª reset fortnight</button>
                </div>
            </div>
            <div class="category-grid">
                <div v-for="(cat, idx) in categories" :key="cat.id" class="category-row">
                    <div class="cat-info">
                        <div class="cat-name-wrapper">
                            <input type="text" class="cat-name" v-model="cat.name" @input="updateStorage" placeholder="name">
                            <button class="delete-cat" @click="removeCategory(cat.id, idx)" title="delete category">‚úï</button>
                        </div>
                        <div class="cat-budget"><span>$</span><input type="number" min="0" step="1" v-model.number="cat.budget" @input="updateStorage" placeholder="budget"></div>
                    </div>
                    <div class="progress-section">
                        <div class="progress-bar-bg"><div class="progress-fill" :style="{ width: progressPercent(cat) }"></div></div>
                        <span class="cat-spent">${{ cat.spent }}</span>
                        <span class="cat-left" :class="{ 'left-warning': cat.budget - cat.spent < 0 }">${{ cat.budget - cat.spent }}</span>
                    </div>
                </div>
            </div>
            <div class="new-cat-row">
                <input type="text" v-model="newCategoryName" placeholder="new category name" @keyup.enter="commitNewCategory">
                <button @click="commitNewCategory">‚ûï add</button>
            </div>

            <div class="add-purchase">
                <div class="form-row">
                    <div class="form-field"><span>üì¶</span><input type="text" v-model="newPurchase.description" placeholder="item name" @keyup.enter="addPurchase"></div>
                    <div class="form-field"><span>$</span><input type="number" min="0" step="0.01" v-model.number="newPurchase.amount" placeholder="0" @keyup.enter="addPurchase"></div>
                </div>
                <div class="form-row">
                    <div class="form-field"><span>üìÇ</span>
                        <select v-model="newPurchase.categoryId">
                            <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.name }}</option>
                        </select>
                    </div>
                    <div class="who-group">
                        <button type="button" class="who-option" :class="{ active: newPurchase.who === 'John' }" @click="newPurchase.who = 'John'">üë® John</button>
                        <button type="button" class="who-option" :class="{ active: newPurchase.who === 'Jane' }" @click="newPurchase.who = 'Jane'">üë© Jane</button>
                    </div>
                </div>
                <button class="add-btn" @click="addPurchase">+ add purchase</button>
            </div>
        </div>

        <div class="card">
            <div class="history-title"><span>üìã purchases this fortnight</span><span>{{ purchases.length }} items</span></div>
            <ul class="purchase-list" v-if="purchases.length">
                <li v-for="(p, index) in sortedPurchases" :key="p.id" class="purchase-item">
                    <div class="purchase-left">
                        <span class="purchase-cat">{{ categoryName(p.categoryId) }}</span>
                        <span class="purchase-who">{{ p.who === 'John' ? 'üë® John' : 'üë© Jane' }}</span>
                        <span class="purchase-name">{{ p.description }}</span>
                    </div>
                    <div><span class="purchase-amount">${{ p.amount.toFixed(2) }}</span><button class="delete-btn" @click="deletePurchase(index, p.id)">‚úï</button></div>
                </li>
            </ul>
            <div v-else style="text-align: center; padding: 32px; color: var(--footer-text);">‚ú® purchases show up here</div>
        </div>
    </div>

    <!-- INCOME & BILLS PAGE -->
    <div v-else>
        <div class="card">
            <div class="summary-card">
                <div class="summary-row"><span>üí∞ Fortnightly income:</span> <span>${{ totalIncome }}</span></div>
                <div class="summary-row"><span>üìÖ Fortnightly bills:</span> <span>${{ totalBillsFortnight.toFixed(2) }}</span></div>
                <div class="summary-row remaining"><span>‚úÖ Left over:</span> <span>${{ (totalIncome - totalBillsFortnight).toFixed(2) }}</span></div>
            </div>

            <h2 style="margin-bottom: 12px; color: var(--text-secondary);">‚ûï Income sources</h2>
            <div class="income-list">
                <div v-for="(inc, idx) in incomeSources" :key="inc.id" class="income-item">
                    <span><strong>{{ inc.name }}</strong> (every fortnight)</span>
                    <div><span class="income-amount">${{ inc.amount }}</span><button class="inline-delete" @click="deleteIncome(idx)">‚úï</button></div>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 8px;">
                    <input type="text" v-model="newIncome.name" placeholder="name (e.g. salary)" style="flex:2; padding: 12px; border-radius: 40px; border:1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary);">
                    <input type="number" v-model="newIncome.amount" placeholder="amount" style="flex:1; padding: 12px; border-radius: 40px; border:1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary);">
                    <button class="btn-outline" @click="addIncome" style="white-space: nowrap;">add</button>
                </div>
            </div>

            <h2 style="margin: 24px 0 12px; color: var(--text-secondary);">üìã Bills</h2>
            <div class="bills-list">
                <div v-for="(bill, idx) in bills" :key="bill.id" class="bill-item">
                    <div class="bill-details">
                        <strong>{{ bill.name }}</strong>
                        <span class="bill-frequency">{{ bill.frequency }}</span>
                        <span class="bill-next" v-if="bill.nextDate && bill.nextDate !== 'optional'">next: {{ formatNextDate(bill.nextDate) }}</span>
                        <span class="bill-next" v-else style="background:#e2eaf2; color:#4d688b;">no date set</span>
                    </div>
                    <div><span class="bill-amount">${{ bill.amount }}</span><button class="inline-delete" @click="deleteBill(idx)">‚úï</button></div>
                </div>
            </div>

            <div class="add-bill-form">
                <h3 style="margin-bottom: 18px; color: var(--text-secondary);">‚ûï Add new bill</h3>
                <div style="display: flex; flex-direction: column; gap: 14px;">
                    <input type="text" v-model="newBill.name" placeholder="Bill name (e.g. rent, internet)" style="padding: 12px; border-radius: 40px; border:1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary);">
                    <input type="number" v-model="newBill.amount" placeholder="Amount $" style="padding: 12px; border-radius: 40px; border:1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary);">
                    
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select v-model="newBill.frequency" style="flex:1; padding: 12px; border-radius: 40px; border:1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="fortnightly">Fortnightly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                        
                        <div style="flex:2; display: flex; align-items: center; gap: 5px;">
                            <input type="date" v-model="newBill.nextDate" style="flex:1; padding: 12px; border-radius: 40px; border:1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary);">
                            <span class="date-optional-hint">(optional)</span>
                        </div>
                    </div>
                    
                    <button class="add-btn" @click="addBill" style="margin-top: 8px;">+ add bill</button>
                </div>
                <p style="color: var(--footer-text); font-size:0.8rem; margin-top: 12px;">If you set a date, we'll auto‚Äëcalculate the next one based on frequency.</p>
            </div>
            <p style="color: var(--footer-text); font-size:0.9rem; margin-top:12px;">Monthly bills are converted to fortnightly for leftover calc.</p>
        </div>
    </div>

    <div class="footer-note">John & Jane ¬∑ click next bill to see calendar ¬∑ dark mode {{ isDarkMode ? 'on' : 'off' }}</div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    const defaultCategories = [
        { id: 'c1', name: 'groceries', budget: 200, spent: 0 },
        { id: 'c2', name: 'dining out', budget: 100, spent: 0 },
        { id: 'c3', name: 'transport', budget: 80, spent: 0 },
        { id: 'c4', name: 'entertainment', budget: 60, spent: 0 },
        { id: 'c5', name: 'household', budget: 70, spent: 0 }
    ];

    const app = createApp({
        setup() {
            const currentPage = ref('expenses');
            const categories = ref([]);
            const purchases = ref([]);
            const newPurchase = reactive({ description: '', amount: null, categoryId: '', who: 'John' });
            const newCategoryName = ref('');

            const incomeSources = ref([]);
            const bills = ref([]);
            const newIncome = reactive({ name: '', amount: null });
            const newBill = reactive({ name: '', amount: null, frequency: 'monthly', nextDate: '' });

            const fileInput = ref(null);
            const showCalendar = ref(false);
            const isDarkMode = ref(false);  // dark mode state

            const fortnightStart = 'Feb 24';
            const fortnightEnd = 'Mar 10';

            // helper: add days
            function addDays(dateStr, days) {
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return null;
                d.setDate(d.getDate() + days);
                return d.toISOString().split('T')[0];
            }

            function computeNextDate(currentDate, frequency) {
                if (!currentDate) return null;
                if (frequency === 'fortnightly') return addDays(currentDate, 14);
                if (frequency === 'monthly') {
                    const d = new Date(currentDate);
                    if (isNaN(d.getTime())) return null;
                    d.setMonth(d.getMonth() + 1);
                    return d.toISOString().split('T')[0];
                }
                return null;
            }

            function generateFutureDates(bill) {
                if (!bill.nextDate) return [];
                let dates = [];
                let current = bill.nextDate;
                const today = new Date();
                today.setHours(0,0,0,0);
                
                for (let i = 0; i < 6; i++) {
                    const d = new Date(current);
                    if (isNaN(d.getTime())) break;
                    
                    if (i === 0 || d >= today) {
                        dates.push({
                            id: bill.id + '_' + i,
                            name: bill.name,
                            amount: bill.amount,
                            frequency: bill.frequency,
                            date: current,
                            isFuture: d >= today
                        });
                    }
                    
                    const next = computeNextDate(current, bill.frequency);
                    if (!next || next === current) break;
                    current = next;
                }
                return dates;
            }

            const calendarEvents = computed(() => {
                let events = [];
                bills.value.forEach(bill => {
                    if (bill.nextDate) {
                        events = events.concat(generateFutureDates(bill));
                    }
                });
                events.sort((a,b) => new Date(a.date) - new Date(b.date));
                return events;
            });

            // dark mode toggle
            function toggleDarkMode() {
                isDarkMode.value = !isDarkMode.value;
                localStorage.setItem('darkMode', isDarkMode.value ? 'true' : 'false');
                // apply class to body
                if (isDarkMode.value) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            }

            // load dark mode preference
            function loadDarkMode() {
                const saved = localStorage.getItem('darkMode');
                if (saved === 'true') {
                    isDarkMode.value = true;
                    document.body.classList.add('dark-mode');
                } else {
                    isDarkMode.value = false;
                    document.body.classList.remove('dark-mode');
                }
            }

            // ---- localStorage ----
            function saveToLocal() {
                localStorage.setItem('expense_categories', JSON.stringify(categories.value));
                localStorage.setItem('expense_purchases', JSON.stringify(purchases.value));
                localStorage.setItem('income_sources', JSON.stringify(incomeSources.value));
                localStorage.setItem('bills_list', JSON.stringify(bills.value));
            }

            function loadFromLocal() {
                categories.value = JSON.parse(localStorage.getItem('expense_categories')) || defaultCategories.map(c => ({...c}));
                purchases.value = JSON.parse(localStorage.getItem('expense_purchases')) || [];
                incomeSources.value = JSON.parse(localStorage.getItem('income_sources')) || [];
                bills.value = JSON.parse(localStorage.getItem('bills_list')) || [];

                categories.value.forEach(c => { if (c.spent === undefined) c.spent = 0; });
                if (categories.value.length && !newPurchase.categoryId) newPurchase.categoryId = categories.value[0].id;
            }

            function recalcSpent() {
                categories.value.forEach(c => c.spent = 0);
                purchases.value.forEach(p => {
                    const cat = categories.value.find(c => c.id === p.categoryId);
                    if (cat) cat.spent += p.amount;
                });
                saveToLocal();
            }

            // expenses
            function addPurchase() {
                if (!newPurchase.description.trim() || !newPurchase.amount || newPurchase.amount <= 0) return alert('Valid description and amount');
                purchases.value.push({
                    id: Date.now()+'-'+Math.random().toString(36).substring(2,8),
                    description: newPurchase.description.trim(),
                    amount: Number(newPurchase.amount),
                    categoryId: newPurchase.categoryId,
                    who: newPurchase.who,
                    timestamp: Date.now()
                });
                newPurchase.description = ''; newPurchase.amount = null;
                recalcSpent();
            }
            function deletePurchase(index) { purchases.value.splice(index, 1); recalcSpent(); }
            function resetFortnight() { if (confirm('Clear purchases?')) { purchases.value = []; recalcSpent(); } }
            function addNewCategoryPrompt() { let n = prompt('Category name:'); if (n?.trim()) addCategory(n.trim()); }
            function addCategory(name) {
                categories.value.push({ id: 'cat_'+Date.now()+'_'+Math.random().toString(36).substring(2,6), name, budget: 50, spent: 0 });
                if (categories.value.length===1) newPurchase.categoryId = categories.value[0].id;
                saveToLocal();
            }
            function commitNewCategory() { if (newCategoryName.value.trim()) { addCategory(newCategoryName.value.trim()); newCategoryName.value = ''; } }
            function removeCategory(catId, idx) {
                if (categories.value.length <= 1) return alert('Keep at least one');
                if (purchases.value.some(p => p.categoryId === catId) && !confirm('Category has purchases. Delete?')) return;
                purchases.value = purchases.value.filter(p => p.categoryId !== catId);
                categories.value.splice(idx, 1);
                if (!categories.value.find(c => c.id === newPurchase.categoryId)) newPurchase.categoryId = categories.value[0]?.id || '';
                recalcSpent();
            }
            function updateStorage() { saveToLocal(); }
            function progressPercent(cat) { return cat.budget<=0 ? '0%' : Math.min((cat.spent/cat.budget)*100,100)+'%'; }
            function categoryName(catId) { return categories.value.find(c=>c.id===catId)?.name || '?'; }
            const sortedPurchases = computed(() => [...purchases.value].sort((a,b)=>b.timestamp - a.timestamp));

            // income
            function addIncome() {
                if (!newIncome.name.trim() || !newIncome.amount || newIncome.amount <=0) return alert('Valid name and amount');
                incomeSources.value.push({ id: Date.now()+'-'+Math.random().toString(36).substring(2,6), name: newIncome.name.trim(), amount: Number(newIncome.amount) });
                newIncome.name = ''; newIncome.amount = null;
                saveToLocal();
            }
            function deleteIncome(idx) { incomeSources.value.splice(idx,1); saveToLocal(); }
            const totalIncome = computed(() => incomeSources.value.reduce((sum,i)=> sum + i.amount, 0));

            // bills
            function addBill() {
                if (!newBill.name.trim() || !newBill.amount || newBill.amount <=0) return alert('Name and amount required (date optional)');
                
                const nextDate = newBill.nextDate && newBill.nextDate.trim() !== '' ? newBill.nextDate : null;
                
                bills.value.push({
                    id: Date.now()+'-'+Math.random().toString(36).substring(2,6),
                    name: newBill.name.trim(),
                    amount: Number(newBill.amount),
                    frequency: newBill.frequency,
                    nextDate: nextDate
                });
                
                newBill.name = ''; newBill.amount = null; newBill.frequency = 'monthly'; newBill.nextDate = '';
                saveToLocal();
            }
            
            function deleteBill(idx) { bills.value.splice(idx,1); saveToLocal(); }

            const totalBillsFortnight = computed(() => {
                return bills.value.reduce((sum, b) => {
                    if (b.frequency === 'fortnightly') return sum + b.amount;
                    else return sum + (b.amount * 12 / 26);
                }, 0);
            });

            function formatNextDate(dateStr) {
                if (!dateStr) return 'not set';
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return dateStr;
                return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
            }

            function formatDate(dateStr) {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
            }

            const nextBillReminder = computed(() => {
                const today = new Date();
                today.setHours(0,0,0,0);
                let nearest = null;
                bills.value.forEach(b => {
                    if (!b.nextDate) return;
                    const d = new Date(b.nextDate);
                    if (!isNaN(d) && d >= today) {
                        if (!nearest || d < nearest) nearest = d;
                    }
                });
                if (!nearest) {
                    let anyDate = null;
                    bills.value.forEach(b => {
                        if (!b.nextDate) return;
                        const d = new Date(b.nextDate);
                        if (!isNaN(d) && (!anyDate || d < anyDate)) anyDate = d;
                    });
                    if (anyDate) return anyDate.toLocaleDateString('en-US',{month:'short', day:'numeric'});
                    return 'no dates';
                }
                return nearest.toLocaleDateString('en-US',{month:'short', day:'numeric'});
            });

            // export/import
            function exportData() {
                const data = { categories: categories.value, purchases: purchases.value, incomeSources: incomeSources.value, bills: bills.value, exportDate: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `expense-tracker-backup-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            function triggerImport() { fileInput.value.click(); }
            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.categories) categories.value = data.categories.map(c => ({ ...c, spent: c.spent || 0 }));
                        if (data.purchases) purchases.value = data.purchases;
                        if (data.incomeSources) incomeSources.value = data.incomeSources;
                        if (data.bills) bills.value = data.bills;
                        if (categories.value.length && !newPurchase.categoryId) newPurchase.categoryId = categories.value[0].id;
                        recalcSpent();
                        alert('Data imported successfully!');
                    } catch { alert('Invalid file'); }
                    event.target.value = '';
                };
                reader.readAsText(file);
            }

            onMounted(() => { 
                loadFromLocal(); 
                recalcSpent();
                loadDarkMode();
            });
            watch([categories, purchases, incomeSources, bills], saveToLocal, { deep: true });

            return {
                currentPage, categories, purchases, newPurchase, newCategoryName,
                incomeSources, bills, newIncome, newBill,
                fortnightStart, fortnightEnd,
                addPurchase, deletePurchase, resetFortnight, addNewCategoryPrompt,
                commitNewCategory, removeCategory, updateStorage, progressPercent,
                categoryName, sortedPurchases, addIncome, deleteIncome, totalIncome,
                addBill, deleteBill, totalBillsFortnight, nextBillReminder, formatNextDate,
                exportData, triggerImport, importData, fileInput,
                showCalendar, calendarEvents, formatDate,
                isDarkMode, toggleDarkMode
            };
        }
    });
    app.mount('#app');
</script>
</body>
</html>
